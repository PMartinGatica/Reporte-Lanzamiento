<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorer | Reporte de Lanzamiento</title>
    <!-- Librer√≠as externas (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Estilos CSS integrados -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }

        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -2;
            overflow: hidden;
        }

        .video-background iframe {
            width: 100vw;
            height: 56.25vw; /* 16:9 aspect ratio */
            min-height: 100vh;
            min-width: 177.77vh; /* 16:9 aspect ratio */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: -1;
        }

        .scroll-down-arrow {
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }

        /* Estilos para el dropdown de status */
        .status-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
        }

        .status-open {
            background-color: #dc2626 !important; /* Red */
            color: white !important;
        }

        .status-ongoing {
            background-color: #d97706 !important; /* Amber (Yellow) */
            color: white !important;
        }

        .status-closed {
            background-color: #059669 !important; /* Green */
            color: white !important;
        }
        
        /* === ESTILOS PARA TARJETAS INTERACTIVAS === */
        .card-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }

        .card-details.expanded {
            max-height: 1000px;
        }

        .kpi-card {
            border-left: 4px solid;
            transition: background-color 0.3s;
        }
        .kpi-card:hover {
            background-color: #374151;
        }
        .kpi-card.good { border-color: #22c55e; }
        .kpi-card.warn { border-color: #f59e0b; }
        .kpi-card.bad { border-color: #ef4444; }

        .details-arrow {
            transition: transform 0.3s ease;
        }
        .details-arrow.expanded {
            transform: rotate(180deg);
        }

        #total-summary-card {
            border: 2px solid #6366f1;
            background-color: #1f2937;
            position: sticky;
            top: 1rem;
            z-index: 20;
        }

        /* === ESTILOS PARA MODAL DE IMAGEN === */
        .image-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .image-modal-content {
            max-width: 90vw;
            max-height: 90vh;
        }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2.5rem;
            color: white;
            cursor: pointer;
        }
        .image-upload-label {
            cursor: pointer;
            background-color: #4f46e5;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .image-upload-label:hover {
            background-color: #4338ca;
        }
        .preview-image {
            max-width: 60px;
            max-height: 40px;
            border-radius: 4px;
            cursor: pointer;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Secci√≥n Hero -->
    <div id="hero" class="h-screen w-full flex flex-col justify-center items-center text-center relative">
        <div class="video-background">
            <video autoplay muted loop playsinline>
    <source src="nice.mp4" type="video/mp4">
    Tu navegador no soporta el elemento video.
</video>
        </div>
        <div class="video-overlay"></div>
        <div class="z-10 p-4">
            <h1 id="hero-title" class="text-6xl md:text-8xl font-black uppercase tracking-widest">Explorer</h1>
            <p id="current-date" class="mt-4 text-lg md:text-xl text-gray-300"></p>
            <p class="mt-2 text-sm md:text-base text-gray-400 uppercase tracking-widest">Reporte de Lanzamiento</p>
        </div>
        <a href="#stats-section" class="absolute bottom-10 z-10">
            <div class="scroll-down-arrow text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
        </a>
    </div>

    <!-- 1. Estado de l√≠nea -->
    <div id="stats-section" class="min-h-screen bg-gray-900 flex flex-col items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-red-500 mb-6">1. Dashboard de Producci√≥n</h2>
            
            <!-- Filtros -->
            <div class="mb-6 flex justify-between items-center flex-wrap gap-4">
                <div class="flex items-center space-x-4">
                    <label for="model-filter" class="text-white font-medium">Modelo:</label>
                    <select id="model-filter" class="bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Cargando modelos...</option>
                    </select>
                </div>
                <div class="flex items-center space-x-4">
                    <label for="date-filter" class="text-white font-medium">Desde fecha:</label>
                    <select id="date-filter" class="bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Todas las fechas</option>
                    </select>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="clear-data-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        üóëÔ∏è Limpiar Datos Guardados
                    </button>
                </div>
                <div id="loading-indicator" class="hidden">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>

            <!-- === CONTENEDOR PARA TARJETAS DE TOTALES Y DIARIAS === -->
            <div id="cards-container" class="space-y-4">
                <!-- La tarjeta de resumen total y las tarjetas diarias se generar√°n aqu√≠ por JS -->
            </div>

            <div class="text-center mt-12">
                <a href="#reports-section" class="text-indigo-400 hover:text-indigo-300 text-lg">Ver Reportes de Procesos &darr;</a>
            </div>
        </div>
    </div>
    
    <!-- 2. Reportes de Procesos -->
    <div id="reports-section" class="min-h-screen bg-gray-900 py-12 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-white">2. An√°lisis de Procesos</h2>
                <button 
                    id="download-pdf-btn" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex items-center space-x-2"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    <span>Descargar PDF</span>
                </button>
            </div>
            <div class="space-y-12" id="process-reports-container">
                <!-- Los reportes se generar√°n din√°micamente aqu√≠ -->
            </div>
        </div>
    </div>
    
    <!-- 3. Seguimiento de Problemas -->
    <div id="issues-section" class="min-h-screen bg-gray-900 py-12 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-white mb-8">3. Seguimiento de Problemas</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-lg shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3">Producto</th>
                                    <th class="px-4 py-3">Descripci√≥n del Problema</th>
                                    <th class="px-4 py-3">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="issues-table-body">
                                <!-- Las filas de problemas se generar√°n aqu√≠ por JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- === MODAL PARA IMAGEN === -->
    <div id="image-modal" style="display: none;" class="image-modal-overlay">
        <span id="close-modal" class="image-modal-close">&times;</span>
        <img id="modal-image" class="image-modal-content" src="" alt="Imagen de Falla">
    </div>

    <!-- Script principal integrado -->
    <script>
        Chart.register(ChartDataLabels);

        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. CONFIGURACI√ìN Y CONSTANTES ---
            const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx5JakaAEwidZ3b9PzTIVV4VeefbRIyA6TaG8OJdNH5ZIgND8FL5ePhV1OughnE3E6Q/exec';
            const FAILURES_API_URL = 'https://script.google.com/macros/s/AKfycbzWtySKBpu3w7GwZIB3fOHYPO93WkEyqMHuYf_lcZe2gN3B7lp-63tRsvpsX8qd50gVRA/exec';
            const STATE_STORAGE_KEY = 'explorerAppState';
            const FAILURE_NOTES_KEY = 'explorerAppFailureNotes';
            const FAILURE_IMAGES_KEY = 'explorerAppFailureImages';
            const ISSUES_STORAGE_KEY = 'explorerAppIssues';
            
            const FTY_TARGETS = {
                'UCT': 98.00, 'FODTEST': 98.00, 'XCVR_LT': 95.00, 'LCDCAL': 98.00,
                'L2VISION': 95.00, 'L2AR': 95.00, 'DEPTHCAL': 98.00, 'DEPTHVAL': 98.00,
                'TELECAL': 98.00, 'TELEVAL': 98.00, 'CFC': 98.00
            };
            const ALL_PROCESSES = ['IFLASH', 'UCT', 'FODTEST', 'XCVR_LT', 'LCDCAL', 'L2VISION', 'L2AR', 'DEPTHCAL', 'DEPTHVAL', 'TELECAL', 'TELEVAL', 'CFC'];
            const ALL_MANUAL_FIELDS = ['CQA1', 'RUNNING', 'CQA2', 'CQA1 Def.', 'CQA2 Def.'];
            
            const initialIssuesData = [
                { id: 1, product: 'EXPLORER', description: 'CQA1 2000' },
                { id: 2, product: 'EXPLORER', description: 'RUNNING: 24hs, 2000' },
                { id: 3, product: 'EXPLORER', description: 'CQA2 2000' },
                { id: 4, product: 'EXPLORER', description: 'BO PACKING' },
                { id: 5, product: 'EXPLORER', description: 'PSO Videos' },
                { id: 6, product: 'EXPLORER', description: 'ORT: 3 unidades' },
                { id: 7, product: 'EXPLORER', description: 'Consumer screen protector: 100pcs.' },
                { id: 8, product: 'EXPLORER', description: '200 Gate: 100 Unidades no destructivo.' },
                { id: 9, product: 'EXPLORER', description: 'R&R' },
                { id: 10, product: 'EXPLORER', description: 'AMFE CFC' },
                { id: 11, product: 'EXPLORER', description: 'PSA activation check: 10pcs. Battery cover, camera deco y Battery PSA.' },
                { id: 12, product: 'EXPLORER', description: 'ISTA (packing). Prioridad.' },
                { id: 13, product: 'EXPLORER', description: 'ALT: 17 muestras (destructivo). Prioridad. Shower test - Tumbler test' },
                { id: 14, product: 'EXPLORER', description: 'BO SW' },
                { id: 15, product: 'EXPLORER', description: 'Droptest' },
                { id: 16, product: 'EXPLORER', description: 'Instructivo CQA1 y CQA2' },
                { id: 17, product: 'EXPLORER', description: 'IQC: Cosm√©tico Funcional' }
            ];

            // --- 2. REFERENCIAS AL DOM ---
            const heroTitle = document.getElementById('hero-title');
            const dateElement = document.getElementById('current-date');
            const modelFilter = document.getElementById('model-filter');
            const dateFilter = document.getElementById('date-filter');
            const loadingIndicator = document.getElementById('loading-indicator');
            const cardsContainer = document.getElementById('cards-container');
            const clearDataBtn = document.getElementById('clear-data-btn');
            const processReportsContainer = document.getElementById('process-reports-container');
            const issuesTableBody = document.getElementById('issues-table-body');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const imageModal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const closeModalBtn = document.getElementById('close-modal');

            // --- 3. ESTADO DE LA APLICACI√ìN ---
            let allData = [];
            let failuresData = [];
            let manualData = {};
            let issuesState = {};
            let failureNotes = {};
            let failureImages = {};
            let currentFilteredData = [];

            // --- 4. FUNCIONES DE INICIALIZACI√ìN ---
            async function initializeApp() {
                setupEventListeners();
                displayCurrentDate();
                renderIssuesTable(); 
                loadStateFromStorage();
                initializeIssueStyles();
                
                showLoading(true);
                try {
                    console.log('üöÄ Starting data fetch...');
                    [allData, failuresData] = await Promise.all([
                        fetchData(APP_SCRIPT_URL),
                        fetchData(FAILURES_API_URL)
                    ]);
                    
                    console.log('üìä All data loaded:', allData.length, 'production rows,', failuresData.length, 'failure rows');
                    
                    populateModelFilter();
                    populateDateFilter();
                    filterAndUpdateUI();
                } catch (error) {
                    console.error('üí• Fatal error during initialization:', error);
                    showErrorInUI(`Error al cargar datos iniciales: ${error.message}`);
                } finally {
                    showLoading(false);
                }
            }

            function setupEventListeners() {
                if (modelFilter) modelFilter.addEventListener('change', handleFilterChange);
                if (dateFilter) dateFilter.addEventListener('change', handleFilterChange);
                if (clearDataBtn) clearDataBtn.addEventListener('click', handleClearData);
                if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', generatePDF);
                if (issuesTableBody) issuesTableBody.addEventListener('change', handleIssueStatusChange);
                
                if (cardsContainer) {
                    cardsContainer.addEventListener('click', handleCardClick);
                    cardsContainer.addEventListener('input', handleCardInput);
                }

                if (processReportsContainer) {
                    processReportsContainer.addEventListener('change', handleProcessReportInteraction);
                    processReportsContainer.addEventListener('click', handleProcessReportInteraction);
                }

                if(imageModal) imageModal.addEventListener('click', () => imageModal.style.display = 'none');
                if(closeModalBtn) closeModalBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    imageModal.style.display = 'none';
                });

            }

            // --- 5. MANEJO DE ESTADO (LocalStorage) ---
            function loadStateFromStorage() {
                try {
                    const savedState = JSON.parse(localStorage.getItem(STATE_STORAGE_KEY) || '{}');
                    manualData = savedState.manualData || {};
                    if (savedState.selectedModel) modelFilter.setAttribute('data-saved-value', savedState.selectedModel);
                    if(savedState.selectedDate) dateFilter.setAttribute('data-saved-value', savedState.selectedDate);

                    failureNotes = JSON.parse(localStorage.getItem(FAILURE_NOTES_KEY) || '{}');
                    failureImages = JSON.parse(localStorage.getItem(FAILURE_IMAGES_KEY) || '{}');
                    issuesState = JSON.parse(localStorage.getItem(ISSUES_STORAGE_KEY) || '{}');
                    applyIssuesState();
                } catch (error) {
                    console.error('Error al cargar estado desde localStorage:', error);
                    manualData = {}; failureNotes = {}; issuesState = {}; failureImages = {};
                }
            }
            
            function saveStateToStorage() {
                try {
                    const state = {
                        manualData,
                        selectedModel: modelFilter.value,
                        selectedDate: dateFilter.value
                    };
                    localStorage.setItem(STATE_STORAGE_KEY, JSON.stringify(state));
                    localStorage.setItem(FAILURE_NOTES_KEY, JSON.stringify(failureNotes));
                    localStorage.setItem(FAILURE_IMAGES_KEY, JSON.stringify(failureImages));
                    localStorage.setItem(ISSUES_STORAGE_KEY, JSON.stringify(issuesState));
                } catch (error) {
                    console.error('Error al guardar estado en localStorage:', error);
                }
            }

            function handleClearData() {
                if (confirm('¬øEst√°s seguro de que quieres eliminar todos los datos guardados? Esta acci√≥n no se puede deshacer.')) {
                    localStorage.clear();
                    manualData = {}; failureNotes = {}; issuesState = {}; failureImages = {};
                    modelFilter.value = ''; dateFilter.value = '';
                    filterAndUpdateUI();
                    showNotification('Datos eliminados correctamente.', 'success');
                }
            }

            // --- 6. OBTENCI√ìN Y PROCESAMIENTO DE DATOS ---
            async function fetchData(url) {
                console.log('üîÑ Fetching data from:', url);
                try {
                    const response = await fetch(url);
                    console.log('üì° Response status:', response.status, response.ok);
                    
                    if (!response.ok) throw new Error(`Error de red: ${response.status}`);
                    
                    const responseData = await response.json();
                    console.log('üì¶ Raw response data:', responseData);
                    
                    if (responseData?.success && Array.isArray(responseData.data)) {
                        console.log('‚úÖ Data parsed successfully, rows:', responseData.data.length);
                        console.log('üìä First few rows:', responseData.data.slice(0, 3));
                        return responseData.data;
                    }
                    
                    console.error('‚ùå Unexpected API response format:', responseData);
                    throw new Error('Formato de respuesta de API inesperado.');
                } catch (error) {
                    console.error('üö® Fetch error:', error);
                    throw error;
                }
            }

            function formatDate(dateString) {
                if (!dateString) return null;
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return null;
                    return date.toISOString().split('T')[0];
                } catch { return null; }
            }
            
            // --- 7. ACTUALIZACI√ìN DE LA INTERFAZ DE USUARIO (UI) ---
            function showLoading(isLoading) {
                loadingIndicator.classList.toggle('hidden', !isLoading);
            }

            function showErrorInUI(message) {
                showLoading(false);
                if (cardsContainer) {
                    cardsContainer.innerHTML = `<div class="bg-red-900/50 text-red-300 p-4 rounded-lg text-center">${message}</div>`;
                }
            }

            function displayCurrentDate() {
                if (dateElement) {
                    dateElement.textContent = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                }
            }

            function handleFilterChange() {
                filterAndUpdateUI();
                saveStateToStorage();
            }

            function filterAndUpdateUI() {
                const selectedModel = modelFilter.value;

                if (heroTitle) {
                    heroTitle.textContent = selectedModel || 'Explorer';
                }

                if (!selectedModel) {
                    if (cardsContainer) cardsContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg text-center text-gray-400">Seleccione un modelo para ver los datos.</div>`;
                    if (processReportsContainer) processReportsContainer.innerHTML = '';
                    return;
                }

                currentFilteredData = allData.filter(item => item.Name === selectedModel);
                
                const selectedDate = dateFilter.value;
                if (selectedDate) {
                    currentFilteredData = currentFilteredData.filter(item => formatDate(item.Date) >= selectedDate);
                }
                
                updateLineStatusSection();
                createProcessReports();
            }
            
            function populateModelFilter() {
                console.log('üîç Populating model filter with data:', allData.length, 'rows');
                
                const uniqueModels = [...new Set(allData.map(item => {
                    console.log('Processing item:', item.Name);
                    return item.Name;
                }).filter(Boolean))];
                
                console.log('üìù Unique models found:', uniqueModels);
                
                modelFilter.innerHTML = '<option value="">Seleccione un modelo</option>';
                uniqueModels.forEach(model => modelFilter.innerHTML += `<option value="${model}">${model}</option>`);
                
                const savedValue = modelFilter.getAttribute('data-saved-value');
                if (savedValue && uniqueModels.includes(savedValue)) {
                   console.log('üíæ Restoring saved model:', savedValue);
                   modelFilter.value = savedValue;
                }
                
                console.log('‚úÖ Model filter populated');
            }

            function populateDateFilter() {
                const uniqueDates = [...new Set(allData.map(item => formatDate(item.Date)).filter(Boolean))].sort().reverse();
                dateFilter.innerHTML = '<option value="">Todas las fechas</option>';
                uniqueDates.forEach(date => dateFilter.innerHTML += `<option value="${date}">${date}</option>`);
                
                const savedValue = dateFilter.getAttribute('data-saved-value');
                if (savedValue && uniqueDates.includes(savedValue)) {
                   dateFilter.value = savedValue;
                }
            }

            // --- 8. SECCI√ìN DE ESTADO DE L√çNEA (VISTA DE TARJETAS) ---
            function updateLineStatusSection() {
                if (!cardsContainer) return;
                
                if (!currentFilteredData || currentFilteredData.length === 0) {
                    cardsContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg text-center text-gray-400">No hay datos para los filtros seleccionados.</div>`;
                    return;
                }

                const dateGroups = currentFilteredData.reduce((acc, item) => {
                    const date = formatDate(item.Date);
                    if (!date) return acc;
                    if (!acc[date]) {
                        acc[date] = { auto: {}, manual: {} };
                    }
                    const process = item.Process || 'SinProceso';
                    const primeHandle = parseInt(item['Prime Handle']) || 0;
                    acc[date].auto[process] = (acc[date].auto[process] || 0) + primeHandle;
                    return acc;
                }, {});

                const sortedDates = Object.keys(dateGroups).sort((a,b) => b.localeCompare(a));
                
                const totals = calculateTotals(dateGroups);
                const totalCardHTML = createTotalSummaryCardHTML(totals);
                const dailyCardsHTML = sortedDates.map(date => createDailyCardHTML(date, dateGroups[date])).join('');

                cardsContainer.innerHTML = totalCardHTML + dailyCardsHTML;
            }

            function calculateTotals(dateGroups) {
                const totals = { 
                    input: 0, output: 0, defects: 0, days: Object.keys(dateGroups).length,
                    processes: {}, manual: {} 
                };

                ALL_PROCESSES.forEach(p => totals.processes[p] = 0);
                ALL_MANUAL_FIELDS.forEach(f => totals.manual[f] = 0);

                for(const date in dateGroups) {
                    const dailyApiData = getDailyApiTotals(date);
                    
                    const input = manualData[date]?.INPUT !== undefined ? parseInt(manualData[date]?.INPUT) : dailyApiData.input;
                    const output = manualData[date]?.Output !== undefined ? parseInt(manualData[date]?.Output) : dailyApiData.output;
                    const defects = manualData[date]?.Defectos !== undefined ? parseInt(manualData[date]?.Defectos) : dailyApiData.defects;
                    
                    totals.input += isNaN(input) ? 0 : input;
                    totals.output += isNaN(output) ? 0 : output;
                    totals.defects += isNaN(defects) ? 0 : defects;
                    
                    for(const process in dateGroups[date].auto) {
                        if(totals.processes.hasOwnProperty(process)) {
                            totals.processes[process] += dateGroups[date].auto[process];
                        }
                    }

                    for(const field in manualData[date]) {
                        if(totals.manual.hasOwnProperty(field)) {
                            totals.manual[field] += parseInt(manualData[date][field]) || 0;
                        }
                    }
                }

                totals.dphu = totals.input > 0 ? (totals.defects * 100 / totals.input) : 0;
                return totals;
            }

            function getDailyApiTotals(date) {
                const dayData = currentFilteredData.filter(item => formatDate(item.Date) === date);
                const totals = { input: 0, output: 0, defects: 0 };
                dayData.forEach(item => {
                    totals.input += parseInt(item['Prime Handle']) || 0;
                    totals.output += parseInt(item['Prime Pass']) || 0;
                    totals.defects += parseInt(item['Prime Fail']) || 0;
                });
                return totals;
            }

            function createTotalSummaryCardHTML(totals) {
                let dphuColorClass = 'good';
                if (totals.dphu > 7) dphuColorClass = 'bad';
                else if (totals.dphu >= 5) dphuColorClass = 'warn';

                return `
                <div id="total-summary-card" class="rounded-lg overflow-hidden shadow-lg mb-6">
                    <div class="p-4 flex flex-col sm:flex-row justify-between items-center cursor-pointer" data-action="toggle-details">
                        <h3 class="text-xl font-bold text-indigo-300 mb-2 sm:mb-0">Resumen del Per√≠odo (${totals.days} d√≠as)</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center w-full sm:w-auto">
                            <div><span class="text-xs text-gray-400 uppercase">Input Total</span><p class="text-2xl font-bold text-blue-400" data-total="input">${totals.input}</p></div>
                            <div><span class="text-xs text-gray-400 uppercase">Salida Total</span><p class="text-2xl font-bold text-green-400" data-total="output">${totals.output}</p></div>
                            <div><span class="text-xs text-gray-400 uppercase">Defectos Totales</span><p class="text-2xl font-bold text-red-400" data-total="defects">${totals.defects}</p></div>
                            <div class="kpi-card ${dphuColorClass} rounded-md p-2" data-total="dphu-card"><span class="text-xs text-gray-400 uppercase">DPHU General</span><p class="text-2xl font-bold" data-total="dphu">${totals.dphu.toFixed(2)}%</p></div>
                        </div>
                         <button class="mt-4 sm:mt-0 text-gray-400 hover:text-white"><svg class="details-arrow w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
                    </div>
                     <div class="card-details bg-gray-900">
                        <div class="p-4 border-t border-gray-700">
                            <h4 class="font-bold mb-2 text-indigo-300">Process Test</h4>
                            <div class="grid grid-cols-3 md:grid-cols-6 gap-4 text-center">
                                ${ALL_PROCESSES.map(p => `<div class="bg-gray-800 p-2 rounded-lg"><p class="text-xs text-gray-400">${p}</p><p class="text-xl font-semibold">${totals.processes[p] || 0}</p></div>`).join('')}
                            </div>
                             <h4 class="font-bold mt-6 mb-2 text-indigo-300">Process Check</h4>
                            <div class="grid grid-cols-3 md:grid-cols-5 gap-4 text-center">
                                ${ALL_MANUAL_FIELDS.map(f => `<div class="bg-gray-800 p-2 rounded-lg"><p class="text-xs text-gray-400">${f.replace(' Def.', ' Defectos')}</p><p class="text-xl font-semibold">${totals.manual[f] || 0}</p></div>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            function createDailyCardHTML(date, dateData) {
                const dailyApiTotals = getDailyApiTotals(date);
                const input = manualData[date]?.INPUT !== undefined ? parseInt(manualData[date]?.INPUT) : dailyApiTotals.input;
                const output = manualData[date]?.Output !== undefined ? parseInt(manualData[date]?.Output) : dailyApiTotals.output;
                const defects = manualData[date]?.Defectos !== undefined ? parseInt(manualData[date]?.Defectos) : dailyApiTotals.defects;
                const dphu = input > 0 ? (defects * 100 / input) : 0;
                
                let dphuColorClass = 'good';
                if (dphu > 7) dphuColorClass = 'bad';
                else if (dphu >= 5) dphuColorClass = 'warn';
                
                return `
                <div class="daily-card bg-gray-800 rounded-lg overflow-hidden shadow-lg" data-date="${date}">
                    <div class="p-4 flex flex-col sm:flex-row justify-between items-center cursor-pointer" data-action="toggle-details">
                        <h3 class="text-xl font-bold text-white mb-2 sm:mb-0">${new Date(date + 'T00:00:00').toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                            <div><span class="text-xs text-gray-400 uppercase">Input</span><p class="text-2xl font-bold text-blue-400" data-kpi="input">${input || 0}</p></div>
                            <div><span class="text-xs text-gray-400 uppercase">Salida</span><p class="text-2xl font-bold text-green-400" data-kpi="output">${output || 0}</p></div>
                            <div><span class="text-xs text-gray-400 uppercase">Defectos</span><p class="text-2xl font-bold text-red-400" data-kpi="defects">${defects || 0}</p></div>
                            <div class="kpi-card ${dphuColorClass} rounded-md p-2" data-kpi="dphu-card"><span class="text-xs text-gray-400 uppercase">DPHU</span><p class="text-2xl font-bold" data-kpi="dphu">${dphu.toFixed(2)}%</p></div>
                        </div>
                        <button class="mt-4 sm:mt-0 text-gray-400 hover:text-white"><svg class="details-arrow w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
                    </div>
                    <div class="card-details bg-gray-900">
                        <div class="p-4 border-t border-gray-700">
                            <h4 class="font-bold mb-2 text-indigo-300">Process Check</h4>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                ${['INPUT', 'Output', 'Defectos', ...ALL_MANUAL_FIELDS].map(header => `
                                <div class="bg-gray-800 p-2 rounded-lg">
                                    <label class="text-xs text-gray-400">${header.replace(' Def.', ' Defectos')}</label>
                                    <input type="number" class="manual-input bg-gray-700 text-white w-full text-lg p-1 rounded" data-field="${header}" value="${manualData[date]?.[header] || ''}" placeholder="${(header === 'INPUT' ? dailyApiTotals.input : header === 'Output' ? dailyApiTotals.output : header === 'Defectos' ? dailyApiTotals.defects : 0) || 0}">
                                </div>`).join('')}
                            </div>
                            <h4 class="font-bold mt-6 mb-2 text-indigo-300">Process Test</h4>
                            <div class="grid grid-cols-3 md:grid-cols-6 gap-4 text-center">
                                ${ALL_PROCESSES.map(header => `<div class="bg-gray-800 p-2 rounded-lg"><p class="text-xs text-gray-400">${header}</p><p class="text-xl font-semibold">${dateData.auto[header] || 0}</p></div>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            
            function handleCardClick(e) {
                const toggleButton = e.target.closest('[data-action="toggle-details"]');
                if (toggleButton) {
                    const card = toggleButton.closest('.daily-card, #total-summary-card');
                    card.querySelector('.card-details')?.classList.toggle('expanded');
                    card.querySelector('.details-arrow')?.classList.toggle('expanded');
                }
            }
            
            function handleCardInput(e) {
                if(e.target.matches('.manual-input')) {
                    const card = e.target.closest('.daily-card');
                    if(!card) return;

                    const date = card.dataset.date;
                    const field = e.target.dataset.field;
                    
                    if (!manualData[date]) manualData[date] = {};
                    manualData[date][field] = e.target.value;
                    
                    updateDailyCardKPIs(card);
                    updateTotalSummaryCard();
                    saveStateToStorage();
                }
            }

            function updateDailyCardKPIs(card) {
                const date = card.dataset.date;
                const dailyApiTotals = getDailyApiTotals(date);
                
                const input = manualData[date]?.INPUT !== undefined && manualData[date]?.INPUT !== '' ? parseInt(manualData[date].INPUT) : dailyApiTotals.input;
                const output = manualData[date]?.Output !== undefined && manualData[date]?.Output !== '' ? parseInt(manualData[date].Output) : dailyApiTotals.output;
                const defects = manualData[date]?.Defectos !== undefined && manualData[date]?.Defectos !== '' ? parseInt(manualData[date].Defectos) : dailyApiTotals.defects;
                const dphu = (input || 0) > 0 ? ((defects || 0) * 100 / (input || 0)) : 0;
                
                card.querySelector('[data-kpi="input"]').textContent = input || 0;
                card.querySelector('[data-kpi="output"]').textContent = output || 0;
                card.querySelector('[data-kpi="defects"]').textContent = defects || 0;
                card.querySelector('[data-kpi="dphu"]').textContent = dphu.toFixed(2) + '%';
                
                const kpiCard = card.querySelector('[data-kpi="dphu-card"]');
                kpiCard.className = 'kpi-card rounded-md p-2 ';
                let dphuColorClass = 'good';
                if (dphu > 7) dphuColorClass = 'bad';
                else if (dphu >= 5) dphuColorClass = 'warn';
                kpiCard.classList.add(dphuColorClass);
            }

            function updateTotalSummaryCard() {
                const dateGroups = currentFilteredData.reduce((acc, item) => {
                    const date = formatDate(item.Date);
                    if (date) acc[date] = acc[date] || {};
                    return acc;
                }, {});

                const totals = calculateTotals(dateGroups);
                const totalCard = document.getElementById('total-summary-card');
                if (!totalCard) return;

                totalCard.querySelector('[data-total="input"]').textContent = totals.input;
                totalCard.querySelector('[data-total="output"]').textContent = totals.output;
                totalCard.querySelector('[data-total="defects"]').textContent = totals.defects;
                totalCard.querySelector('[data-total="dphu"]').textContent = totals.dphu.toFixed(2) + '%';

                const dphuCard = totalCard.querySelector('[data-total="dphu-card"]');
                dphuCard.className = 'kpi-card rounded-md p-2 ';
                let dphuColorClass = 'good';
                if (totals.dphu > 7) dphuColorClass = 'bad';
                else if (totals.dphu >= 5) dphuColorClass = 'warn';
                dphuCard.classList.add(dphuColorClass);
            }

            // --- 9. REPORTES DE PROCESOS (GR√ÅFICOS Y TABLAS DE FALLAS) ---
            function createProcessReports() {
                 if (!processReportsContainer) return;
                processReportsContainer.innerHTML = ''; 

                const processesWithData = [...new Set(currentFilteredData.map(item => item.Process).filter(Boolean))];
                
                processesWithData.forEach(processName => {
                    const processDataForChart = currentFilteredData.filter(item => item.Process === processName);
                    
                    const reportElement = createProcessReportElement(processName);
                    processReportsContainer.appendChild(reportElement);
                    
                    createProcessChart(processName, processDataForChart, reportElement);
                    updateFailuresTable(processName, reportElement);
                });
            }

            function createProcessReportElement(processName) {
                const reportElement = document.createElement('div');
                reportElement.className = 'bg-gray-800 p-6 rounded-lg shadow-lg mb-6';
                reportElement.dataset.process = processName;
                
                reportElement.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-4">${processName}</h3>
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-center">
                        <div class="bg-gray-700 p-3 rounded-lg"><p class="text-sm text-gray-400">FTY%</p><p class="text-3xl font-bold text-green-400" data-metric-fty-total="true">0.00%</p></div>
                        <div class="bg-gray-700 p-3 rounded-lg"><p class="text-sm text-gray-400">NTF%</p><p class="text-3xl font-bold text-yellow-400" data-metric-ntf-total="true">0.00%</p></div>
                        <div class="bg-gray-700 p-3 rounded-lg"><p class="text-sm text-gray-400">DPHU%</p><p class="text-3xl font-bold text-red-400" data-metric-dphu-total="true">0.00%</p></div>
                    </div>
                    <div class="relative h-96"><canvas data-chart="${processName}"></canvas></div>
                    <div class="failures-table-container mt-6"></div>
                `;
                return reportElement;
            }

            function updateFailuresTable(processName, reportElement) {
                const container = reportElement.querySelector('.failures-table-container');
                const processFailures = failuresData.filter(f => f.process === processName);
                const top5Failures = processFailures
                    .sort((a,b) => (parseInt(b.pfail) || 0) - (parseInt(a.pfail) || 0))
                    .slice(0, 5);

                if (top5Failures.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 mt-6">No se encontraron datos de fallas para este proceso en el per√≠odo seleccionado.</p>';
                    return;
                }
                
                const rowsHTML = top5Failures.map(failure => {
                    const notes = failureNotes[processName]?.[failure.testcode] || {};
                    const imageSrc = failureImages[processName]?.[failure.testcode];
                    const imageCellHTML = imageSrc
                        ? `<div><img src="${imageSrc}" class="preview-image mx-auto" data-action="show-image"><button data-action="remove-image" class="text-red-500 text-xs mt-1">Quitar</button></div>`
                        : `<label class="image-upload-label" for="upload-${processName}-${failure.testcode}">Subir</label><input type="file" id="upload-${processName}-${failure.testcode}" class="hidden" accept="image/*" data-action="upload-image">`;

                    return `
                        <tr class="border-b border-gray-600 hover:bg-gray-700" data-testcode="${failure.testcode}">
                            <td class="px-4 py-3 text-center">${failure.testcode}</td>
                            <td class="px-4 py-3 text-center">${failure.pfail}</td>
                            <td class="px-4 py-3 text-center">${failure.pfailph?.formatted || '0.00%'}</td>
                            <td class="px-4 py-3 text-center">${failure.pntf || 0}</td>
                            <td class="px-4 py-3"><textarea class="w-full bg-gray-700 text-white px-2 py-1 rounded resize-y min-h-[38px]" placeholder="Causa..." data-action="save-note" data-type="causa" style="overflow-y:hidden">${notes.causa || ''}</textarea></td>
                            <td class="px-4 py-3"><textarea class="w-full bg-gray-700 text-white px-2 py-1 rounded resize-y min-h-[38px]" placeholder="Acci√≥n..." data-action="save-note" data-type="accion" style="overflow-y:hidden">${notes.accion || ''}</textarea></td>
                            <td class="px-4 py-3 text-center">${imageCellHTML}</td>
                        </tr>
                    `;
                }).join('');

                container.innerHTML = `
                    <h4 class="text-lg font-semibold mb-2">Top 5 Fallas</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-200">
                            <thead class="text-xs uppercase bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3">Testcode</th><th class="px-4 py-3">Fallas</th><th class="px-4 py-3">Fail %</th>
                                    <th class="px-4 py-3">NTF</th><th class="px-4 py-3">Causas</th><th class="px-4 py-3">Acciones</th><th class="px-4 py-3">Imagen</th>
                                </tr>
                            </thead>
                            <tbody>${rowsHTML}</tbody>
                        </table>
                    </div>`;
            }

            function handleProcessReportInteraction(e) {
                const action = e.target.dataset.action;
                if (!action) return;

                const processReport = e.target.closest('[data-process]');
                const processName = processReport.dataset.process;
                const failureRow = e.target.closest('tr');
                const testcode = failureRow?.dataset.testcode;

                switch(action) {
                    case 'save-note':
                        if (!failureNotes[processName]) failureNotes[processName] = {};
                        if (!failureNotes[processName][testcode]) failureNotes[processName][testcode] = {};
                        failureNotes[processName][testcode][e.target.dataset.type] = e.target.value;
                        saveStateToStorage();
                        break;
                    
                    case 'upload-image':
                        handleImageUpload(e.target, processName, testcode);
                        break;

                    case 'show-image':
                        modalImage.src = e.target.src;
                        imageModal.style.display = 'flex';
                        break;
                    
                    case 'remove-image':
                        if (confirm('¬øQuitar esta imagen?')) {
                            delete failureImages[processName][testcode];
                            saveStateToStorage();
                            updateFailuresTable(processName, processReport);
                        }
                        break;
                }
            }

            function handleImageUpload(inputElement, processName, testcode) {
                const file = inputElement.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const b64 = e.target.result;
                    if (!failureImages[processName]) failureImages[processName] = {};
                    failureImages[processName][testcode] = b64;
                    saveStateToStorage();
                    updateFailuresTable(processName, inputElement.closest('[data-process]'));
                };
                reader.readAsDataURL(file);
            }

            function createProcessChart(processName, processData, reportElement) {
                const canvas = reportElement.querySelector(`[data-chart="${processName}"]`);
                if (!canvas) return;
                
                let totalHandle = 0, totalPass = 0, totalNTF = 0, totalDefect = 0;
                processData.forEach(item => {
                    totalHandle += parseInt(item['Prime Handle']) || 0;
                    totalPass += parseInt(item['Prime Pass']) || 0;
                    totalNTF += parseInt(item['Prime NTF Count']) || 0;
                    totalDefect += parseInt(item['Prime Defect Count']) || 0;
                });
                
                const totalFty = totalHandle > 0 ? (totalPass * 100 / totalHandle) : 0;
                const totalNtfPercent = totalHandle > 0 ? (totalNTF * 100 / totalHandle) : 0;
                const totalDphuPercent = totalHandle > 0 ? (totalDefect * 100 / totalHandle) : 0;
                
                reportElement.querySelector('[data-metric-fty-total]').textContent = `${totalFty.toFixed(2)}%`;
                reportElement.querySelector('[data-metric-ntf-total]').textContent = `${totalNtfPercent.toFixed(2)}%`;
                reportElement.querySelector('[data-metric-dphu-total]').textContent = `${totalDphuPercent.toFixed(2)}%`;

                const groupedData = processData.reduce((acc, item) => {
                    const date = formatDate(item.Date);
                    if (!date) return acc;
                    acc[date] = acc[date] || { primeHandle: 0, primePass: 0, primeFail: 0 };
                    acc[date].primeHandle += parseInt(item['Prime Handle']) || 0;
                    acc[date].primePass += parseInt(item['Prime Pass']) || 0;
                    acc[date].primeFail += parseInt(item['Prime Fail']) || 0;
                    return acc;
                }, {});
                
                const sortedDates = Object.keys(groupedData).sort();
                
                const tooltipData = sortedDates.map(date => {
                    const dayData = groupedData[date];
                    return {
                        date: new Date(date + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: 'long' }),
                        handle: dayData.primeHandle,
                        pass: dayData.primePass,
                        fail: dayData.primeFail,
                        fty: dayData.primeHandle > 0 ? (dayData.primePass * 100 / dayData.primeHandle) : 0,
                    };
                });
                
                if (canvas.chart) canvas.chart.destroy();
                
                canvas.chart = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: tooltipData.map(d => d.date),
                        datasets: [{
                            type: 'bar', label: 'Prime Handle', data: tooltipData.map(d => d.handle),
                            backgroundColor: (context) => {
                                const {ctx, chartArea} = context.chart;
                                if (!chartArea) return null;
                                const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                                gradient.addColorStop(1, 'rgba(59, 130, 246, 0.8)');
                                return gradient;
                            },
                            borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1.5, yAxisID: 'y',
                        }, {
                            type: 'line', label: 'FTY%', data: tooltipData.map(d => d.fty),
                            borderColor: '#f87171', backgroundColor: '#f87171', tension: 0.4,
                            pointRadius: 5, pointHoverRadius: 7, pointBackgroundColor: '#f87171', yAxisID: 'y1',
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Prime Handle', color: 'white'}, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)'} },
                            y1: { type: 'linear', display: true, position: 'right', min: 0, max: 110, title: { display: true, text: 'FTY%', color: 'white' }, ticks: { color: 'white', callback: v => v + '%' }, grid: { drawOnChartArea: false } },
                            x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)'}}
                        },
                        plugins: {
                            legend: { labels: { color: 'white' } },
                            tooltip: {
                                enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                titleFont: { size: 14, weight: 'bold' }, bodyFont: { size: 12 }, padding: 10, boxPadding: 5,
                                callbacks: {
                                    title: (ctx) => tooltipData[ctx[0].dataIndex].date,
                                    label: (ctx) => {
                                        const day = tooltipData[ctx.dataIndex];
                                        return ctx.dataset.type === 'line' ? `FTY: ${day.fty.toFixed(2)}%` : [`Volumen: ${day.handle}`, `  - OK: ${day.pass}`, `  - Fallas: ${day.fail}`];
                                    }
                                }
                            },
                            datalabels: {
                                color: 'white', anchor: 'end', align: 'top', font: { weight: 'bold' },
                                formatter: (value, context) => context.dataset.type === 'line' ? value.toFixed(1) + '%' : (value > 0 ? value : '')
                            }
                        }
                    },
                    plugins: [{
                        id: 'targetLine',
                        afterDraw: (chart) => {
                            const targetValue = FTY_TARGETS[processName];
                            if (!targetValue) return;
                            const { ctx, chartArea: { left, right }, scales: { y1 } } = chart;
                            const y = y1.getPixelForValue(targetValue);
                            ctx.save();
                            ctx.strokeStyle = '#22c55e';
                            ctx.lineWidth = 2;
                            ctx.setLineDash([6, 6]);
                            ctx.beginPath();
                            ctx.moveTo(left, y);
                            ctx.lineTo(right, y);
                            ctx.stroke();
                            ctx.fillStyle = '#22c55e';
                            ctx.font = 'bold 12px Inter';
                            ctx.textAlign = 'right';
                            ctx.fillText(`Meta: ${targetValue}%`, right - 5, y - 5);
                            ctx.restore();
                        }
                    }]
                });
            }

            // --- 10. SEGUIMIENTO DE PROBLEMAS ---
            function renderIssuesTable() {
                if (!issuesTableBody) return;
                issuesTableBody.innerHTML = initialIssuesData.map(issue => `
                    <tr data-id="${issue.id}" class="border-b border-gray-700">
                        <td class="px-4 py-2 text-white">${issue.product}</td>
                        <td class="px-4 py-2 text-white">${issue.description}</td>
                        <td class="px-4 py-2">
                            <select class="status-select w-full p-2 rounded border-0 text-white font-bold" data-status-select>
                                <option value="Open" selected>Abierto</option>
                                <option value="On going">En Progreso</option>
                                <option value="Closed">Cerrado</option>
                            </select>
                        </td>
                    </tr>
                `).join('');
            }

            function initializeIssueStyles() {
                if (!issuesTableBody) return;
                issuesTableBody.querySelectorAll('[data-status-select]').forEach(select => {
                    updateStatusStyle(select);
                });
            }

            function applyIssuesState() {
                if (!issuesTableBody) return;
                Object.entries(issuesState).forEach(([issueId, data]) => {
                    const select = issuesTableBody.querySelector(`tr[data-id="${issueId}"] select`);
                    if (select && data.status) select.value = data.status;
                });
            }

            function updateStatusStyle(selectElement) {
                selectElement.classList.remove('status-open', 'status-ongoing', 'status-closed');
                const statusClass = {
                    'Open': 'status-open',
                    'On going': 'status-ongoing',
                    'Closed': 'status-closed'
                }[selectElement.value];
                if (statusClass) selectElement.classList.add(statusClass);
            }

            function handleIssueStatusChange(e) {
                if (e.target.matches('[data-status-select]')) {
                    const select = e.target;
                    const issueId = select.closest('tr').dataset.id;
                    issuesState[issueId] = { status: select.value };
                    updateStatusStyle(select);
                    saveStateToStorage();
                }
            }

            // --- 11. GENERACI√ìN DE PDF ---
            async function generatePDF() {
                const { jsPDF } = window.jspdf;
                if (!jsPDF || !window.html2canvas) {
                    showNotification('Error: Librer√≠as PDF no cargadas.', 'error');
                    return;
                }

                showPDFLoading(true);
                const pdf = new jsPDF('p', 'mm', 'a4');
                let yPos = 0;

                try {
                    // --- P√ÅGINA 1: PORTADA ---
                    await addCoverPageToPDF(pdf);

                    // --- P√ÅGINA 2: RESUMEN GENERAL ---
                    pdf.addPage();
                    yPos = 20;
                    pdf.setFontSize(18);
                    pdf.text('Resumen General del Per√≠odo', 105, yPos, { align: 'center' });
                    yPos += 15;
                    const summaryCard = document.getElementById('total-summary-card');
                    if (summaryCard) {
                        const canvas = await html2canvas(summaryCard, { backgroundColor: '#111827', useCORS: true });
                        const imgData = canvas.toDataURL('image/png', 1.0);
                        const imgWidth = 180;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        pdf.addImage(imgData, 'PNG', 15, yPos, imgWidth, imgHeight);
                        yPos += imgHeight + 15;
                    }

                    // --- P√ÅGINAS DE AN√ÅLISIS DE PROCESOS ---
                    const processReports = document.querySelectorAll('#process-reports-container > div');
                    for (const report of processReports) {
                         if (yPos > 220) {
                             pdf.addPage();
                             yPos = 20;
                         }
                        const canvas = await html2canvas(report, { backgroundColor: '#1f2937', useCORS: true });
                        const imgData = canvas.toDataURL('image/png', 1.0);
                        const imgWidth = 180;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        if (yPos + imgHeight > 280) {
                           pdf.addPage();
                           yPos = 20;
                        }
                        
                        pdf.addImage(imgData, 'PNG', 15, yPos, imgWidth, imgHeight);
                        yPos += imgHeight + 10;
                    }
                    
                    // --- P√ÅGINA DE SEGUIMIENTO DE PROBLEMAS ---
                    pdf.addPage();
                    yPos = 20;
                    pdf.setFontSize(18);
                    pdf.text('Seguimiento de Problemas', 105, yPos, { align: 'center' });
                    yPos += 15;
                    const issuesTable = document.getElementById('issues-section').querySelector('table');
                    if(issuesTable) {
                         const canvas = await html2canvas(issuesTable, { 
                             backgroundColor: '#1f2937', 
                             useCORS: true,
                             onclone: (doc) => {
                                 doc.querySelectorAll('select').forEach(sel => {
                                     const text = sel.options[sel.selectedIndex].text;
                                     const span = doc.createElement('span');
                                     span.textContent = text;
                                     span.style.color = 'white';
                                     sel.parentNode.replaceChild(span, sel);
                                 });
                             }
                         });
                        const imgData = canvas.toDataURL('image/png', 1.0);
                        const imgWidth = 180;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        pdf.addImage(imgData, 'PNG', 15, yPos, imgWidth, imgHeight);
                    }


                    const filename = `Reporte_MQS_${modelFilter.value || 'General'}_${new Date().toISOString().split('T')[0]}.pdf`;
                    pdf.save(filename);
                    showNotification('PDF generado exitosamente.', 'success');

                } catch (error) {
                    console.error("Error al generar PDF:", error);
                    showNotification('Error al generar el PDF.', 'error');
                } finally {
                    showPDFLoading(false);
                }
            }
            
            async function addCoverPageToPDF(pdf) {
                const coverImageBase64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/2wBDAQMDAwQDBAgEBAgQCwkLEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBD/wAARCAH0A+gDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9U6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK
                        <span>Descargar PDF</span>`;
                }
            }

            // --- INICIAR LA APP ---
            initializeApp();
        });
    </script>

</body>
</html>
